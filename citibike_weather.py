## Configuration
module load python/gnu/3.4.4
module load spark/2.2.0
export PYSPARK_PYTHON=/share/apps/python/3.4.4/bin/python
export PYTHONHASHSEED=0
export SPARK_YARN_USER_ENV=PYTHONHASHSEED=0
pyspark 

## Citibike-Weather Merge
bike_weather = spark.read.format("csv").options(header="true", inferschema="true").load("bike_weather.csv")
bike_weather.createOrReplaceTempView("bike_weather")
bike_weather = spark.sql("SELECT * FROM bike_weather WHERE mean_duration IS NOT NULL")
bike_weather.createOrReplaceTempView("bike_weather")

bike_weather.printSchema()
## returns
root
 |-- _c0: integer (nullable = true)
 |-- Temp: double (nullable = true)
 |-- Spd: double (nullable = true)
 |-- Prcp: double (nullable = true)
 |-- day_x: timestamp (nullable = true)
 |-- merge_date: integer (nullable = true)
 |-- mean_duration: double (nullable = true)
 |-- num_trips: integer (nullable = true)
 |-- day_y: timestamp (nullable = true)

bike_weather.show()
## returns
+---+------------------+------------------+------------------+-------------------+----------+------------------+---------+-------------------+
|_c0|              Temp|               Spd|              Prcp|              day_x|merge_date|     mean_duration|num_trips|              day_y|
+---+------------------+------------------+------------------+-------------------+----------+------------------+---------+-------------------+
|912| 22.83421052631578|4.9921052631578915|              58.8|2013-07-01 00:00:00|  20130701| 978.5992792792791|    16650|2013-07-01 00:00:00|
|913|23.210344827586205| 5.799999999999998|               1.6|2013-07-02 00:00:00|  20130702| 958.1295669377887|    22745|2013-07-02 00:00:00|
|914|23.536363636363635| 4.724242424242422|27.099999999999998|2013-07-03 00:00:00|  20130703| 974.3284851811197|    21864|2013-07-03 00:00:00|
|915|24.679310344827588| 4.282758620689656|               6.3|2013-07-04 00:00:00|  20130704|1273.1084385917763|    22326|2013-07-04 00:00:00|
|916|25.992000000000004|             4.804|               0.0|2013-07-05 00:00:00|  20130705| 1082.426609284864|    21842|2013-07-05 00:00:00|
|917|27.604166666666668|            4.8375|               0.0|2013-07-06 00:00:00|  20130706|1159.5757072360386|    20467|2013-07-06 00:00:00|
|918| 28.10416666666666| 4.558333333333333|               0.0|2013-07-07 00:00:00|  20130707|1118.2994090931288|    20477|2013-07-07 00:00:00|
|919|             27.25| 5.741666666666667|               0.0|2013-07-08 00:00:00|  20130708|1289.5298635207032|    21615|2013-07-08 00:00:00|
|920|25.904166666666665|            4.8125|               0.0|2013-07-09 00:00:00|  20130709| 965.9312713486732|    26641|2013-07-09 00:00:00|
|921| 25.11935483870968| 4.264516129032257|               5.6|2013-07-10 00:00:00|  20130710|  931.917262552464|    25732|2013-07-10 00:00:00|
|922|25.939999999999998| 3.476666666666665|               2.0|2013-07-11 00:00:00|  20130711|1009.7180652823853|    24417|2013-07-11 00:00:00|
|923| 24.07812500000001|          4.634375|               3.5|2013-07-12 00:00:00|  20130712| 938.1076502157215|    19006|2013-07-12 00:00:00|
|924|23.615624999999994| 4.068749999999997|              23.5|2013-07-13 00:00:00|  20130713|1116.9396607833378|    26119|2013-07-13 00:00:00|
|925| 26.57083333333334| 4.645833333333335|               0.0|2013-07-14 00:00:00|  20130714|1161.7602690613585|    29287|2013-07-14 00:00:00|
|926|           29.5125| 3.637499999999999|               0.0|2013-07-15 00:00:00|  20130715| 919.0969396843492|    28069|2013-07-15 00:00:00|
|927|30.483333333333324| 4.270833333333334|               0.0|2013-07-16 00:00:00|  20130716| 907.7130554252395|    29842|2013-07-16 00:00:00|
|928|30.579166666666666|3.1958333333333333|               0.0|2013-07-17 00:00:00|  20130717| 880.1669721767594|    30550|2013-07-17 00:00:00|
|929|30.241666666666664|4.3083333333333345|               0.0|2013-07-18 00:00:00|  20130718| 862.8295403373862|    28869|2013-07-18 00:00:00|
|930|           30.1875| 4.675000000000002|               0.0|2013-07-19 00:00:00|  20130719| 880.2631717498401|    26591|2013-07-19 00:00:00|
|931|30.123999999999995| 6.660000000000001|               0.5|2013-07-20 00:00:00|  20130720|1076.8692934567607|    25278|2013-07-20 00:00:00|
+---+------------------+------------------+------------------+-------------------+----------+------------------+---------+-------------------+

spark.sql("SELECT * FROM bike_weather WHERE num_trips > 30000").show()
